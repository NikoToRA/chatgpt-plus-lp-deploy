name: ğŸ”„ Claude Token Refresher
on:
  # ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
  workflow_dispatch:
    inputs:
      force_refresh:
        description: 'å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥'
        type: boolean
        default: false
  # schedule:
  #   # æ¯æ—¥åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
  #   - cron: '0 0 * * *'
jobs:
  check-and-refresh:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”§ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ“… Check Token Expiry
        id: check_expiry
        run: |
          CURRENT_TIME=$(date +%s)
          EXPIRES_AT="${{ secrets.CLAUDE_EXPIRES_AT }}"
          EXPIRES_AT_SEC=$((EXPIRES_AT / 1000))
          
          echo "Current time: $CURRENT_TIME"
          echo "Token expires at: $EXPIRES_AT_SEC"
          
          # 24æ™‚é–“ä»¥å†…ã«æœŸé™åˆ‡ã‚Œã«ãªã‚‹å ´åˆã¯æ›´æ–°
          BUFFER_TIME=$((24 * 60 * 60))  # 24 hours
          REFRESH_TIME=$((EXPIRES_AT_SEC - BUFFER_TIME))
          
          if [ $CURRENT_TIME -gt $REFRESH_TIME ] || [ "${{ github.event.inputs.force_refresh }}" = "true" ]; then
            echo "needs_refresh=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Token needs refresh (expires in less than 24 hours)"
          else
            echo "needs_refresh=false" >> $GITHUB_OUTPUT
            echo "âœ… Token is still valid"
          fi
          
      - name: ğŸ”„ Refresh Token
        if: steps.check_expiry.outputs.needs_refresh == 'true'
        id: refresh_token
        run: |
          # ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦æ–°ã—ã„ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
          # Claude OAuth API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆæ¨å®šï¼‰
          REFRESH_RESPONSE=$(curl -s -X POST \
            https://claude.ai/api/oauth/refresh \
            -H "Content-Type: application/json" \
            -d "{\"refreshToken\": \"${{ secrets.CLAUDE_REFRESH_TOKEN }}\"}")
          
          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±ã‚’æŠ½å‡º
          NEW_ACCESS_TOKEN=$(echo "$REFRESH_RESPONSE" | jq -r '.accessToken')
          NEW_EXPIRES_AT=$(echo "$REFRESH_RESPONSE" | jq -r '.expiresAt')
          
          if [ "$NEW_ACCESS_TOKEN" != "null" ] && [ ! -z "$NEW_ACCESS_TOKEN" ]; then
            echo "âœ… Token refreshed successfully"
            echo "new_access_token=$NEW_ACCESS_TOKEN" >> $GITHUB_OUTPUT
            echo "new_expires_at=$NEW_EXPIRES_AT" >> $GITHUB_OUTPUT
          else
            echo "âŒ Failed to refresh token"
            exit 1
          fi
          
      - name: ğŸ“ Create Update Issue
        if: steps.check_expiry.outputs.needs_refresh == 'true' && steps.refresh_token.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = `## ğŸ”„ Claude Token æ›´æ–°ãŒå¿…è¦ã§ã™
            
            æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚ä»¥ä¸‹ã®æ‰‹é †ã§æ›´æ–°ã—ã¦ãã ã•ã„ï¼š
            
            ### æ‰‹å‹•æ›´æ–°æ‰‹é †
            1. [Repository Settings](https://github.com/${{ github.repository }}/settings/secrets/actions) ã«ã‚¢ã‚¯ã‚»ã‚¹
            2. ä»¥ä¸‹ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’æ›´æ–°:
               - \`CLAUDE_ACCESS_TOKEN\`: (æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚è¡¨ç¤ºã—ã¾ã›ã‚“)
               - \`CLAUDE_EXPIRES_AT\`: \`${{ steps.refresh_token.outputs.new_expires_at }}\`
            
            ### ã¾ãŸã¯è‡ªå‹•æ›´æ–°ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
            \`\`\`bash
            # ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œ
            ./get_claude_tokens.sh
            # è¡¨ç¤ºã•ã‚ŒãŸå€¤ã§GitHub Secretsã‚’æ›´æ–°
            \`\`\`
            
            â° æœ‰åŠ¹æœŸé™: ${new Date(parseInt('${{ steps.refresh_token.outputs.new_expires_at }}')).toLocaleString('ja-JP')}
            
            ã“ã®Issueã¯24æ™‚é–“å¾Œã«è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã™ã€‚`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ”„ Claude Token æ›´æ–°ãŒå¿…è¦',
              body: issueBody,
              labels: ['maintenance', 'urgent'],
              assignees: ['${{ github.repository_owner }}']
            });
