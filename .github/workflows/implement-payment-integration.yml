name: 'ðŸ’³ Issue 6: æ±ºæ¸ˆé€£æºèª¿æŸ»ã¨å®Ÿè£…'

on:
  workflow_dispatch:
    inputs:
      payment_service:
        description: 'æ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹é¸æŠž'
        required: true
        default: 'stripe'
        type: choice
        options:
        - stripe
        - square
        - paypal
      business_type:
        description: 'ãƒ“ã‚¸ãƒã‚¹ã‚¿ã‚¤ãƒ—'
        required: true
        default: 'subscription'
        type: choice
        options:
        - subscription
        - one_time
        - both

jobs:
  research-and-implement:
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ”§ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'api/package-lock.json'
        
    - name: ðŸ“¦ Install Dependencies
      run: |
        cd api
        npm ci
        
    - name: ðŸ”§ Install Payment Service Package
      run: |
        cd api
        case "${{ github.event.inputs.payment_service }}" in
          "stripe")
            npm install stripe
            ;;
          "square")
            npm install squareup
            ;;
          "paypal")
            npm install @paypal/checkout-server-sdk
            ;;
        esac
        
    - name: ðŸ“‹ Generate Payment Service Research
      run: |
        mkdir -p docs/payment-research
        
        cat > docs/payment-research/README.md << 'EOF'
        # ðŸ’³ æ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹é€£æºèª¿æŸ»çµæžœ
        
        **é¸æŠžã‚µãƒ¼ãƒ“ã‚¹:** ${{ github.event.inputs.payment_service }}  
        **ãƒ“ã‚¸ãƒã‚¹ã‚¿ã‚¤ãƒ—:** ${{ github.event.inputs.business_type }}  
        **èª¿æŸ»æ—¥:** $(date)
        
        ## ã‚µãƒ¼ãƒ“ã‚¹æ¦‚è¦
        EOF
        
        case "${{ github.event.inputs.payment_service }}" in
          "stripe")
            cat >> docs/payment-research/README.md << 'EOF'
        
        ### Stripe
        - **æœˆé¡æ‰‹æ•°æ–™:** 3.6%
        - **ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³:** âœ… å¯¾å¿œ
        - **æ—¥æœ¬å††å¯¾å¿œ:** âœ… å¯¾å¿œ
        - **å¿…è¦æ›¸é¡ž:** æ³•äººç¢ºèªæ›¸é¡ž
        - **å¯©æŸ»æœŸé–“:** 1-3å–¶æ¥­æ—¥
        
        #### æ–™é‡‘ãƒ—ãƒ©ãƒ³ä¾‹
        - ChatGPT Plus 1ãƒ¦ãƒ¼ã‚¶ãƒ¼: Â¥6,000/æœˆ
        - ChatGPT Plus 5ãƒ¦ãƒ¼ã‚¶ãƒ¼: Â¥27,500/æœˆ (Â¥5,500/ãƒ¦ãƒ¼ã‚¶ãƒ¼)
        - ChatGPT Plus 10ãƒ¦ãƒ¼ã‚¶ãƒ¼: Â¥50,000/æœˆ (Â¥5,000/ãƒ¦ãƒ¼ã‚¶ãƒ¼)
        
        #### API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
        - **é¡§å®¢ä½œæˆ:** `POST /v1/customers`
        - **ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ä½œæˆ:** `POST /v1/subscriptions`
        - **è«‹æ±‚æ›¸ç¢ºèª:** `GET /v1/invoices`
        EOF
            ;;
          "square")
            cat >> docs/payment-research/README.md << 'EOF'
        
        ### Square
        - **æœˆé¡æ‰‹æ•°æ–™:** 3.25%
        - **ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³:** âœ… å¯¾å¿œ
        - **æ—¥æœ¬å††å¯¾å¿œ:** âœ… å¯¾å¿œ
        - **å¯©æŸ»æœŸé–“:** å³æ—¥-1å–¶æ¥­æ—¥
        EOF
            ;;
          "paypal")
            cat >> docs/payment-research/README.md << 'EOF'
        
        ### PayPal
        - **æœˆé¡æ‰‹æ•°æ–™:** 3.6% + Â¥40
        - **ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³:** âœ… å¯¾å¿œ
        - **æ—¥æœ¬å††å¯¾å¿œ:** âœ… å¯¾å¿œ
        - **å¯©æŸ»æœŸé–“:** 1-2å–¶æ¥­æ—¥
        EOF
            ;;
        esac
        
    - name: ðŸ“ Generate API Implementation Sample
      run: |
        cd api
        
        cat > paymentService.js << 'EOF'
        // ${{ github.event.inputs.payment_service }} æ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹çµ±åˆ
        
        EOF
        
        case "${{ github.event.inputs.payment_service }}" in
          "stripe")
            cat >> paymentService.js << 'EOF'
        const stripe = require('stripe')(process.env.STRIPE_SECRET_KEY);

        class PaymentService {
          // é¡§å®¢ä½œæˆ
          async createCustomer(customerData) {
            try {
              const customer = await stripe.customers.create({
                email: customerData.email,
                name: customerData.name,
                metadata: {
                  organization: customerData.organization,
                  accounts: customerData.accounts
                }
              });
              return customer;
            } catch (error) {
              console.error('Stripe customer creation failed:', error);
              throw error;
            }
          }

          // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ä½œæˆ
          async createSubscription(customerId, priceId) {
            try {
              const subscription = await stripe.subscriptions.create({
                customer: customerId,
                items: [{ price: priceId }],
                payment_behavior: 'default_incomplete',
                expand: ['latest_invoice.payment_intent'],
              });
              return subscription;
            } catch (error) {
              console.error('Stripe subscription creation failed:', error);
              throw error;
            }
          }

          // ä¾¡æ ¼è¨ˆç®—
          calculatePrice(accounts) {
            const accountCount = parseInt(accounts.replace(/[^0-9]/g, '')) || 1;
            let pricePerAccount = 6000; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä¾¡æ ¼
            
            if (accountCount >= 11) {
              pricePerAccount = 5000;
            } else if (accountCount >= 4) {
              pricePerAccount = 5500;
            }
            
            return {
              accountCount: accountCount <= 3 ? 3 : accountCount,
              pricePerAccount,
              totalPrice: (accountCount <= 3 ? 3 : accountCount) * pricePerAccount,
              discount: accountCount >= 4 ? 'å¤§å£å‰²å¼•é©ç”¨' : null
            };
          }

          // Webhookå‡¦ç†
          async handleWebhook(payload, signature) {
            try {
              const event = stripe.webhooks.constructEvent(
                payload,
                signature,
                process.env.STRIPE_WEBHOOK_SECRET
              );

              switch (event.type) {
                case 'payment_intent.succeeded':
                  console.log('Payment succeeded:', event.data.object);
                  break;
                case 'subscription.created':
                  console.log('Subscription created:', event.data.object);
                  break;
                default:
                  console.log(`Unhandled event type: ${event.type}`);
              }

              return { received: true };
            } catch (error) {
              console.error('Webhook signature verification failed:', error);
              throw error;
            }
          }
        }

        module.exports = new PaymentService();
        EOF
            ;;
          "square")
            cat >> paymentService.js << 'EOF'
        const { Client, Environment } = require('squareup');

        const client = new Client({
          accessToken: process.env.SQUARE_ACCESS_TOKEN,
          environment: process.env.NODE_ENV === 'production' ? Environment.Production : Environment.Sandbox
        });

        class PaymentService {
          async createCustomer(customerData) {
            try {
              const { result } = await client.customersApi.createCustomer({
                emailAddress: customerData.email,
                givenName: customerData.name,
                companyName: customerData.organization
              });
              return result.customer;
            } catch (error) {
              console.error('Square customer creation failed:', error);
              throw error;
            }
          }

          async createSubscription(customerId, planId) {
            try {
              const { result } = await client.subscriptionsApi.createSubscription({
                locationId: process.env.SQUARE_LOCATION_ID,
                customerId: customerId,
                planId: planId
              });
              return result.subscription;
            } catch (error) {
              console.error('Square subscription creation failed:', error);
              throw error;
            }
          }
        }

        module.exports = new PaymentService();
        EOF
            ;;
        esac
        
    - name: ðŸ“ Generate Azure Function for Payment
      run: |
        mkdir -p api/payment
        
        cat > api/payment/function.json << 'EOF'
        {
          "bindings": [
            {
              "authLevel": "function",
              "type": "httpTrigger",
              "direction": "in",
              "name": "req",
              "methods": ["post"]
            },
            {
              "type": "http",
              "direction": "out",
              "name": "res"
            }
          ]
        }
        EOF
        
        cat > api/payment/index.js << 'EOF'
        const paymentService = require('../paymentService');

        module.exports = async function (context, req) {
          context.log('Payment endpoint called');

          try {
            const { action, ...data } = req.body;

            switch (action) {
              case 'create_customer':
                const customer = await paymentService.createCustomer(data);
                context.res = {
                  status: 200,
                  body: { success: true, customer }
                };
                break;

              case 'create_subscription':
                const subscription = await paymentService.createSubscription(
                  data.customerId, 
                  data.priceId
                );
                context.res = {
                  status: 200,
                  body: { success: true, subscription }
                };
                break;

              case 'calculate_price':
                const pricing = paymentService.calculatePrice(data.accounts);
                context.res = {
                  status: 200,
                  body: { success: true, pricing }
                };
                break;

              default:
                context.res = {
                  status: 400,
                  body: { error: 'Unknown action' }
                };
            }
          } catch (error) {
            context.log.error('Payment processing failed:', error);
            context.res = {
              status: 500,
              body: { error: error.message }
            };
          }
        };
        EOF
        
    - name: ðŸ“‹ Generate Implementation Checklist
      run: |
        cat > PAYMENT_IMPLEMENTATION.md << 'EOF'
        # ðŸ’³ æ±ºæ¸ˆæ©Ÿèƒ½å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
        
        ## âœ… å®Œäº†æ¸ˆã¿
        - [x] ${{ github.event.inputs.payment_service }} SDK ã®è¿½åŠ 
        - [x] åŸºæœ¬çš„ãªPayment APIã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ä½œæˆ
        - [x] Azure Function ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä½œæˆ
        - [x] ä¾¡æ ¼è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…
        
        ## ðŸ“ æ¬¡ã«å¿…è¦ãªä½œæ¥­
        
        ### 1. ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š
        - [ ] ${{ github.event.inputs.payment_service }} ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ
        - [ ] API ã‚­ãƒ¼ã®å–å¾—
        - [ ] Webhook URLè¨­å®š
        
        ### 2. ç’°å¢ƒå¤‰æ•°è¨­å®š
        Azure Static Web Apps ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š
        ```
        EOF
        
        case "${{ github.event.inputs.payment_service }}" in
          "stripe")
            cat >> PAYMENT_IMPLEMENTATION.md << 'EOF'
        STRIPE_SECRET_KEY=sk_test_...
        STRIPE_PUBLISHABLE_KEY=pk_test_...
        STRIPE_WEBHOOK_SECRET=whsec_...
        EOF
            ;;
          "square")
            cat >> PAYMENT_IMPLEMENTATION.md << 'EOF'
        SQUARE_ACCESS_TOKEN=your_access_token
        SQUARE_LOCATION_ID=your_location_id
        EOF
            ;;
        esac
        
        cat >> PAYMENT_IMPLEMENTATION.md << 'EOF'
        ```
        
        ### 3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±åˆ
        - [ ] æ±ºæ¸ˆãƒœã‚¿ãƒ³ã‚’LPã«è¿½åŠ 
        - [ ] ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆãƒ•ãƒ­ãƒ¼ã®å®Ÿè£…
        - [ ] æˆåŠŸ/å¤±æ•—ãƒšãƒ¼ã‚¸ã®ä½œæˆ
        
        ### 4. ãƒ†ã‚¹ãƒˆ
        - [ ] ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã®æ±ºæ¸ˆãƒ†ã‚¹ãƒˆ
        - [ ] Webhookã®å‹•ä½œç¢ºèª
        - [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ç¢ºèª
        
        ## ðŸ’° æ–™é‡‘è¨­å®š
        EOF
        
        if [ "${{ github.event.inputs.business_type }}" = "subscription" ]; then
          cat >> PAYMENT_IMPLEMENTATION.md << 'EOF'
        
        ### ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³
        - **1-3ãƒ¦ãƒ¼ã‚¶ãƒ¼**: Â¥18,000/æœˆ (Â¥6,000/ãƒ¦ãƒ¼ã‚¶ãƒ¼)
        - **4-10ãƒ¦ãƒ¼ã‚¶ãƒ¼**: Â¥55,000/æœˆ (Â¥5,500/ãƒ¦ãƒ¼ã‚¶ãƒ¼) 
        - **11+ãƒ¦ãƒ¼ã‚¶ãƒ¼**: Â¥50,000+/æœˆ (Â¥5,000/ãƒ¦ãƒ¼ã‚¶ãƒ¼)
        EOF
        fi
        
    - name: ðŸš€ Commit and Push Changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git commit -m "ðŸ’³ Issue 6: ${{ github.event.inputs.payment_service }}æ±ºæ¸ˆé€£æºã®åŸºç¤Žå®Ÿè£…

        âœ… å®Ÿè£…å†…å®¹:
        - ${{ github.event.inputs.payment_service }} SDKçµ±åˆ
        - åŸºæœ¬çš„ãªæ±ºæ¸ˆAPIå®Ÿè£…
        - ä¾¡æ ¼è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (${{ github.event.inputs.business_type }})
        - Azure Function ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
        - å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆä½œæˆ

        ðŸ“ æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«:
        - api/paymentService.js - æ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹çµ±åˆ
        - api/payment/index.js - æ±ºæ¸ˆAPI ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ 
        - docs/payment-research/ - èª¿æŸ»è³‡æ–™
        - PAYMENT_IMPLEMENTATION.md - å®Ÿè£…æ‰‹é †

        ðŸ¤– Generated with GitHub Actions"
        git push
        
    - name: ðŸ“Š Create Implementation Status Issue
      uses: actions/github-script@v7
      with:
        script: |
          const issueBody = `## ðŸ’³ æ±ºæ¸ˆé€£æºã®åŸºç¤Žå®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸï¼

          ### ðŸŽ¯ å®Ÿè£…ã•ã‚ŒãŸæ©Ÿèƒ½
          - **æ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹**: ${{ github.event.inputs.payment_service }}
          - **ãƒ“ã‚¸ãƒã‚¹ã‚¿ã‚¤ãƒ—**: ${{ github.event.inputs.business_type }}
          - **åŸºæœ¬API**: é¡§å®¢ä½œæˆã€ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã€ä¾¡æ ¼è¨ˆç®—

          ### ðŸ“ ä½œæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
          - \`api/paymentService.js\` - æ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹çµ±åˆ
          - \`api/payment/index.js\` - æ±ºæ¸ˆAPI
          - \`docs/payment-research/\` - èª¿æŸ»è³‡æ–™
          - \`PAYMENT_IMPLEMENTATION.md\` - å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

          ### ðŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
          1. **${{ github.event.inputs.payment_service }} ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š**
          2. **API ã‚­ãƒ¼è¨­å®š** (ç’°å¢ƒå¤‰æ•°)
          3. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ±ºæ¸ˆãƒœã‚¿ãƒ³è¿½åŠ **
          4. **ãƒ†ã‚¹ãƒˆæ±ºæ¸ˆã®å®Ÿè¡Œ**

          ### ðŸ’° è¨­å®šã•ã‚ŒãŸæ–™é‡‘ãƒ—ãƒ©ãƒ³
          - 1-3ãƒ¦ãƒ¼ã‚¶ãƒ¼: Â¥18,000/æœˆ
          - 4-10ãƒ¦ãƒ¼ã‚¶ãƒ¼: Â¥55,000/æœˆ  
          - 11+ãƒ¦ãƒ¼ã‚¶ãƒ¼: Â¥50,000+/æœˆ

          è©³ç´°ãªæ‰‹é †ã¯ \`PAYMENT_IMPLEMENTATION.md\` ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

          /close #6`;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸ’³ æ±ºæ¸ˆé€£æºåŸºç¤Žå®Ÿè£…å®Œäº† - ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®šãŒå¿…è¦',
            body: issueBody,
            labels: ['enhancement', 'payment', 'ready-for-setup']
          });